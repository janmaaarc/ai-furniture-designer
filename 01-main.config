commands:
  01_get_webhook_url:
    # This command runs during deployment on the EC2 instance.
    # It fetches the secret parameter and creates a file that Apache can read.
    # Note: This requires the EC2 instance role to have permission to access the parameter.
    command: |
      aws ssm get-parameter --name "/ai-furniture/webhook-url" --with-decryption --query "Parameter.Value" --output text > /tmp/webhook_url.txt
      echo "SetEnv N8N_WEBHOOK_URL $(cat /tmp/webhook_url.txt)" > /etc/httpd/conf.d/webhook.conf

files:
  # This file will prepend the webhook URL to the main PHP script.
  "/etc/httpd/conf.d/inject_variable.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      php_value auto_prepend_file "/var/app/current/inject_webhook.php"